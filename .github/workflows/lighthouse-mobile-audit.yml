name: Lighthouse Mobile Audit

on:
  workflow_dispatch:
  pull_request:

permissions:
  contents: read
  packages: read

jobs:
  lighthouse-mobile-audit:
    if: github.repository_owner == 'plentymarkets'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node and Yarn
        uses: ./.github/actions/setup
        with:
          npm-auth-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set environment
        run: |
          touch apps/web/.env
          cat <<EOT >> apps/web/.env
          API_SECURITY_TOKEN=${{ secrets.API_SECURITY_TOKEN }}
          API_ENDPOINT=https://mevofvd5omld.c01-14.plentymarkets.com
          ${{ vars.CONFIG }}
          EOT

      - name: Install Dependencies
        run: yarn --immutable

      - name: Build application
        run: yarn build

      - name: lighthouse mobile audit
        run: yarn lhci:mobile

      - name: lighthouse desktop audit
        run: yarn lhci:desktop
